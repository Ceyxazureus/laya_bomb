var gameMain=function(){function t(){this._startx=90,this._starty=80,this._stricks={},this._players=new Array,server.on("user.JoinRep",this,this.handleJoinRep),server.on("game.GameMessageNtf",this,this.handleGameMessageNtf),server.on("game.QuitGameRep",this,this.handleQuitGameRep),server.on("game.SetSession",this,this.handleSetSession),server.on("game.MapNtf",this,this.handleMapNtf),server.on("game.OperateNtf",this,this.handleOperateNtf),server.on("game.GameEndNtf",this,this.handleGameEndNtf),server.on("game.LeaveTable",this,this.handleLeaveTable),server.on("user.NotifyKickout",this,this.handleNotifyKickout)}return t.prototype.handleNotifyKickout=function(t){1==t.reason&&Laya.stage.addChild(new promptView("您的账号已经在别处登陆！"))},t.prototype.handleLeaveTable=function(t){if(t){console.log(1);for(var e=0;e<this._players.length;++e){console.log(2);var o=this._players[e];o&&o._uid==t.uid&&(console.log(3),o.removeSelf(),o.destroy(),this._players[e]=void 0)}}},t.prototype.handleGameEndNtf=function(){console.log("游戏结束！")},t.prototype.destroyBlock=function(t,e){t&&t[e]&&(t[e].removeSelf(),t[e].destroy(),t[e]=void 0,this._map[e]=3)},t.prototype.handleOperateNtf=function(t){if(t)if(2==t.result)for(var e=0;e<t.opt.length;e+=3){var o=t.opt[e],i=t.opt[e+1],n=new Laya.Sprite;n.loadImage("comp/bomb.png"),this._bg.addChild(n);var s=this.calc_pos_xy(i,this._width,this._height-10);if(n.pos(s[0],s[1]-10),this._bg.setChildIndex(this._bg.getChildAt(this._bg.numChildren-1),this._bg.numChildren-4),o==this._uid)this._self._blocks[i]=n;else for(var a=0,r=this._players;a<r.length;a++){var h=r[a];if(h._uid==o){h._blocks[i]=n;break}}}else if(3==t.result){var i=t.opt[0];if(t.uid==this._uid){this.destroyBlock(this._self._blocks,i);for(var e=1;e<t.opt.length;++e)this.destroyBlock(this._stricks,t.opt[e]);t.score&&t.score>0&&(this._bg.m_score1.text=t.score.toString())}else for(var p=0,l=this._players;p<l.length;p++){var h=l[p];if(h._uid==t.uid){this.destroyBlock(h._blocks,i);for(var e=1;e<t.opt.length;++e)this.destroyBlock(this._stricks,t.opt[e]);t.score&&t.score>0&&(this._bg.m_score2.text=t.score.toString())}}}},t.prototype.calc_pos_xy=function(t,e,o,i,n){var s=t%15,a=Math.floor(t/15);return i=i?i:this._startx,n=n?n:this._starty,e=e?e:this._width,o=o?o:this._height,[i+s*e,n+a*o]},t.prototype.createOtherPlayer=function(t,e){var o=new player;o._uid=t,o.loadImage("comp/front.png"),this._bg.addChild(o);var i=new Laya.Text;i.text=o._uid.toString(),i.pos(0,-o.height/2),i.align="center",i.fontSize=20,o.addChild(i);var n=this.calc_pos_xy(e,this._width,this._height-10);o.pos(n[0],n[1]-10),this._players.push(o)},t.prototype.calc_pos_index=function(t,e){var o=15*Math.floor((e-this._starty)/(this._height-10)),i=(t-this._startx)/this._width,n=Math.floor(Math.floor(o)+i);return n},t.prototype.send_pos=function(t){server&&(t=t?t:this.calc_pos_index(this._self.x,this._self.y+20),console.log(t),server.sendData("game.SelfMessageNtf",{session:this._session,pos:t}))},t.prototype.can_move=function(t,e){var o=this.calc_pos_index(t,e);return this._map[o]&&this._map[o]==Define.EMPTYPLACE?!0:!1},t.prototype.moveDown=function(){this.can_move(this._self.x,this._self.y+20+this._height-10,Define.DOWN)&&(this._self.y+=this._height-10,this.send_pos())},t.prototype.moveUp=function(){this.can_move(this._self.x,this._self.y+20-this._height+10,Define.UP)&&(this._self.y-=this._height-10,this.send_pos())},t.prototype.moveLeft=function(){this.can_move(this._self.x-this._width,this._self.y+20,Define.LEFT)&&(this._self.x-=this._width,this.send_pos())},t.prototype.moveRight=function(){this.can_move(this._self.x+this._width,this._self.y+20,Define.RIGHT)&&(this._self.x+=this._width,this.send_pos())},t.prototype.handleMove=function(t){switch(t){case Define.DOWN:this.moveDown();break;case Define.UP:this.moveUp();break;case Define.LEFT:this.moveLeft();break;case Define.RIGHT:this.moveRight()}},t.prototype.handleBomb=function(){var t=this.calc_pos_index(this._self.x,this._self.y+20);server.sendData("game.OperateReq",{session:this._session,optn:2,opt:[this._uid,t+1,1]})},t.prototype.initButton=function(){var t=this,e=this._bg;e.m_down.on(Laya.Event.CLICK,this,this.handleMove,[Define.DOWN]),e.m_up.on(Laya.Event.CLICK,this,this.handleMove,[Define.UP]),e.m_left.on(Laya.Event.CLICK,this,this.handleMove,[Define.LEFT]),e.m_right.on(Laya.Event.CLICK,this,this.handleMove,[Define.RIGHT]),e.bt_bomb.on(Laya.Event.CLICK,this,this.handleBomb),e.m_down.on(Laya.Event.MOUSE_DOWN,this,function(){t._bg.m_down.alpha=1}),e.m_up.on(Laya.Event.MOUSE_DOWN,this,function(){t._bg.m_up.alpha=1}),e.m_left.on(Laya.Event.MOUSE_DOWN,this,function(){t._bg.m_left.alpha=1}),e.m_right.on(Laya.Event.MOUSE_DOWN,this,function(){t._bg.m_right.alpha=1}),e.bt_bomb.on(Laya.Event.MOUSE_DOWN,this,function(){t._bg.bt_bomb.alpha=1}),e.m_down.on(Laya.Event.MOUSE_UP,this,function(){t._bg.m_down.alpha=.5}),e.m_up.on(Laya.Event.MOUSE_UP,this,function(){t._bg.m_up.alpha=.5}),e.m_left.on(Laya.Event.MOUSE_UP,this,function(){t._bg.m_left.alpha=.5}),e.m_right.on(Laya.Event.MOUSE_UP,this,function(){t._bg.m_right.alpha=.5}),e.bt_bomb.on(Laya.Event.MOUSE_UP,this,function(){t._bg.bt_bomb.alpha=.5})},t.prototype.handleMapNtf=function(t){this._map=t.wall,this._bg=new gameBg,this._self=new player,this._bg.bt_close.on(Laya.Event.CLICK,this,this.closeBack),Laya.stage.addChild(this._bg),this.initButton();for(var e=this._bg,o=0;o<t.wall.length;++o){var i=t.wall[o],n=o%15,s=Math.floor(o/15);if(i==Define.STRICK){var a=new Laya.Sprite;a.loadImage("comp/strick.png"),e.addChild(a);var r=a.height-10,h=a.width;a.pos(this._startx+n*h,this._starty+s*r),this._stricks[o]=a}else if(i==Define.STONE){var a=new Laya.Sprite;a.loadImage("comp/stone.png"),e.addChild(a);var r=a.height-10,h=a.width;this._height=a.height,this._width=a.width,this._numchildIndex=e.numChildren,a.pos(this._startx+n*h,this._starty+s*r)}}for(var p=0,l=["up","down","left","right","bomb"];p<l.length;p++){var c=l[p],_=e.getChildByName(c);_&&e.setChildIndex(_,e.numChildren-1)}for(var o=0;o<t.pos.length;o+=2){var u=t.pos[o],d=t.pos[o+1];if(u==this._uid){var f=this._self;f.loadImage("comp/front.png"),e.addChild(f);var g=this.calc_pos_xy(d,this._width,this._height-10);f.pos(g[0],g[1]-10);var y=new Laya.Text;y.text=this._uid.toString(),y.pos(0,-f.height/2),y.align="center",y.fontSize=20,this._self.addChild(y)}else this.createOtherPlayer(u,d)}},t.prototype.rand=function(t,e){return Math.floor(Math.random()*(e-t+1)+t)},t.prototype.handleSetSession=function(t){t&&t.session?this._session=Number(t.session):console.log("Not have session")},t.prototype.handleGameMessageNtf=function(t){for(var e=0;e<t.pmsg.length;e+=2)for(var o=t.pmsg[e],i=t.pmsg[e+1],n=0,s=this._players;n<s.length;n++){var a=s[n];if(a._uid==o){var r=this.calc_pos_xy(i,this._width,this._height-10);console.log("here  ",i,r[0],r[1]-10),a.pos(r[0],r[1]-10)}}},t.prototype.handleQuitGameRep=function(){},t.prototype.closeBack=function(){server&&(server.sendData("game.QuitGameReq",{session:this._session,uid:this._uid}),server.logout());for(var t=0,e=this._players;t<e.length;t++){var o=e[t];o.removeSelf(),o.destroy()}this._self.removeSelf(),this._self.destroy(),Laya.stage.addChild(new loginView)},t.prototype.handleJoinRep=function(t){0!=t.result&&Laya.stage.addChild(new promptView("加入游戏失败："+t.result))},t.prototype.mainProcess=function(t){this._uid=t,server.sendData("user.JoinReq",{uid:this._uid,roomid:1e3})},t}(),ProtoIDs=function(){function t(){}return t.getMap=function(){var t={};return t[1e3]="game.QuitGameReq",t["game.QuitGameReq"]=1e3,t[1001]="game.QuitGameRep",t["game.QuitGameRep"]=1001,t[1002]="game.MapNtf",t["game.MapNtf"]=1002,t[1003]="game.SelfMessageNtf",t["game.SelfMessageNtf"]=1003,t[1004]="game.GameMessageNtf",t["game.GameMessageNtf"]=1004,t[1005]="game.OperateReq",t["game.OperateReq"]=1005,t[1006]="game.OperateNtf",t["game.OperateNtf"]=1006,t[1007]="game.GameEndNtf",t["game.GameEndNtf"]=1007,t[1008]="game.SetSession",t["game.SetSession"]=1008,t[1009]="game.LeaveTable",t["game.LeaveTable"]=1009,t[2e3]="user.UserInfoRequest",t["user.UserInfoRequest"]=2e3,t[2001]="user.UserInfoResonpse",t["user.UserInfoResonpse"]=2001,t[2002]="user.JoinReq",t["user.JoinReq"]=2002,t[2003]="user.JoinRep",t["user.JoinRep"]=2003,t[2004]="user.NotifyKickout",t["user.NotifyKickout"]=2004,t},t}(),Define=function(){function t(){}return t.UP=1,t.DOWN=2,t.LEFT=3,t.RIGHT=4,t.STONE=1,t.STRICK=2,t.EMPTYPLACE=3,t.PLAYER=4,t.DEBUG_NET=!0,t}(),__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),Server=function(t){function e(){var e=t.call(this)||this;e._connectReady=!1,e._heartTimer=new Laya.Timer,e._socket=new Laya.Socket,e._socket.endian=Laya.Socket.BIG_ENDIAN,e._socket.on(Laya.Event.OPEN,e,e.onSocketOpen),e._socket.on(Laya.Event.CLOSE,e,e.onSocketClose),e._socket.on(Laya.Event.MESSAGE,e,e.onMessageReveived),e._socket.on(Laya.Event.ERROR,e,e.onConnectError),e._protoIDs=ProtoIDs.getMap();var o=Laya.Browser.window.protobuf;return e._protoBuilderUserMap=o.load("res/proto/user.proto"),e._protoBuilderGameMap=o.load("res/proto/game.proto"),e}return __extends(e,t),e.prototype.logout=function(){this._socket.close()},e.prototype.connect=function(t){this._uid=t;var e="ws://47.96.161.239:7001/ws";this._socket.connectByUrl(e)},e.prototype.onSocketOpen=function(){if(this._uid){var t="123",e="123",o=123,i=123,n=[this._uid,1,t,e,o,i].join(":"),s=new Laya.Byte;s.endian=Laya.Socket.BIG_ENDIAN,s.writeUint16(0),s.writeUTFBytes(n),this._socket.send(s.buffer),this._socket.flush(),this._connectReady=!0}else console.log("Not have uid!")},e.prototype.onSocketClose=function(){console.log("socket close"),this.event("CONNECT_CLOSE"),this._heartTimer.clearAll(this),this._connectReady=!1},e.prototype.onMessageReveived=function(t){var e=this,o=new Laya.Byte;o.writeArrayBuffer(t),o.pos=0,o.endian=Laya.Socket.BIG_ENDIAN;var i=(o.getUint16(),o.getUint16());switch(i){case 0:console.log("登录成功"),this._heartTimer.loop(100,this,this.onHeartBeat),this.event("LOGIN_SUCCESS",this._uid);break;case 1:console.log("登录失败"),this.event("LOGIN_FAILED");break;case 2:console.log("收到心跳");break;default:var n=this._protoIDs[i];if(!n){console.log("没有ID为"+i+"的协议!");break}var s=n.indexOf("."),a=n.substring(0,s),r=n.substring(s+1),h=void 0;h="user"==a?this._protoBuilderUserMap:this._protoBuilderGameMap,h.then(function(t){var s=t.lookup(n);if(s){Define.DEBUG_NET&&console.log("Find name : "+n+", id = "+i+", module:"+a+",action:"+r);var h=s.decode(o.getUint8Array(4,o.length-4));e.event(n,h)}else console.log("Can not find name : "+n+", id = "+i+", module:"+a+",action:"+r)})}},e.prototype.onConnectError=function(){console.log("connect error"),this.event("CONNECT_ERROR"),this._connectReady=!1},e.prototype.onHeartBeat=function(){this._connectReady||console.log("In heartBeat, the connection id closed!")},e.prototype.sendData=function(t,e,o){var i=this;if(void 0===o&&(o=null),!this._connectReady)return console.log("sendData socket close"),this.event("CONNECT_CLOSE"),void 0;var n=t.indexOf("."),s=t.substring(0,n);if(!e||!t)return console.log(" send data not have name or data"),void 0;var a;a="user"==s?this._protoBuilderUserMap:this._protoBuilderGameMap,a.then(function(o){var n=o.lookup(t);if(n){var s=n.create(e),a=n.verify(s);if(a)return console.log(a),void 0;var r=n.encode(s).finish(),h=new Laya.Byte;h.endian=Laya.Byte.BIG_ENDIAN,h.writeUint16(r.length+2),h.writeUint16(i._protoIDs[t]),h.writeArrayBuffer(r),i._socket.send(h.buffer),i._socket.flush(),Define.DEBUG_NET&&console.log("send data:",t,",id:",i._protoIDs[t])}else console.log("encode error ",t)})},e}(Laya.EventDispatcher),server,__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),View=laya.ui.View,Dialog=laya.ui.Dialog,ui;!function(t){var e=function(e){function o(){return e.call(this)||this}return __extends(o,e),o.prototype.createChildren=function(){e.prototype.createChildren.call(this),this.createView(t.gamebgUI.uiView)},o.uiView={type:"View",props:{width:600,height:400},child:[{type:"Image",props:{y:0,x:0,"var":"bt_game_bg",skin:"comp/bg2.png",name:"gamebg"}},{type:"Label",props:{y:50,x:202,width:67,"var":"m_score1",text:"0",height:25,fontSize:20,font:"SimHei",color:"#01000b",borderColor:"#40e20d",bold:!0,align:"center"}},{type:"Image",props:{y:50,x:146,width:47,"var":"m_scoreLable1",skin:"comp/score.png",name:"scoreLable1",height:39}},{type:"Label",props:{y:50,x:370,width:67,"var":"m_score2",text:"0",height:25,fontSize:20,font:"SimHei",color:"#88100e",borderColor:"#40e20d",align:"center"}},{type:"Image",props:{y:50,x:314,width:47,"var":"m_scoreLable2",skin:"comp/score.png",name:"scoreLable2",height:39}},{type:"Button",props:{y:278,x:56,width:30,"var":"m_up",skin:"comp/button.png",name:"up",label:"up",height:30,alpha:.5}},{type:"Button",props:{y:333,x:56,width:30,"var":"m_down",skin:"comp/button.png",name:"down",label:"down",height:30,alpha:.5}},{type:"Button",props:{y:307,x:87,width:30,"var":"m_right",skin:"comp/button.png",name:"right",label:"right",height:30,alpha:.5}},{type:"Button",props:{y:307,x:25,width:30,"var":"m_left",skin:"comp/button.png",name:"left",label:"left",height:30,alpha:.5}},{type:"Button",props:{y:29,x:480,"var":"bt_close",skin:"comp/button.png",label:"back"}},{type:"Button",props:{y:307,x:516,width:40,"var":"bt_bomb",skin:"comp/button.png",name:"bomb",label:"bomb",height:40,alpha:.5}}]},o}(View);t.gamebgUI=e}(ui||(ui={})),function(t){var e=function(e){function o(){return e.call(this)||this}return __extends(o,e),o.prototype.createChildren=function(){e.prototype.createChildren.call(this),this.createView(t.loginUI.uiView)},o.uiView={type:"View",props:{width:600,height:400},child:[{type:"Image",props:{y:0,x:0,width:600,skin:"comp/bg.png",sizeGrid:"30,5,5,5",height:400}},{type:"Label",props:{y:170,x:125,width:160,text:"请输入uid:",height:30,fontSize:30,font:"楷体",color:"#0b0707",bold:!0}},{type:"TextInput",props:{y:172,x:288,width:200,"var":"bt_input",skin:"comp/textinput.png",sizeGrid:"4,4,4,4",restrict:"0123456789",prompt:"请输入1~100之间的整数",height:30}},{type:"Button",props:{y:267,x:223.5,width:153,"var":"bt_login",skin:"comp/button.png",sizeGrid:"4,4,4,4",label:"LOGIN",height:69}}]},o}(View);t.loginUI=e}(ui||(ui={})),function(t){var e=function(e){function o(){return e.call(this)||this}return __extends(o,e),o.prototype.createChildren=function(){e.prototype.createChildren.call(this),this.createView(t.promptUI.uiView)},o.uiView={type:"View",props:{width:600,height:400},child:[{type:"Image",props:{y:0,x:0,width:600,skin:"comp/bg.png",sizeGrid:"30,5,5,5",height:400}},{type:"Button",props:{y:267,x:223,width:153,"var":"bt_return",skin:"comp/button.png",sizeGrid:"4,4,4,4",label:"RETURN",height:69}},{type:"Label",props:{y:109,x:146,width:324,"var":"bt_prompt",height:113,align:"center"}}]},o}(View);t.promptUI=e}(ui||(ui={}));var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),gameBg=function(t){function e(){return t.call(this)||this}return __extends(e,t),e}(ui.gamebgUI),__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),player=function(t){function e(){var e=t.call(this)||this;return e._blocks={},e}return __extends(e,t),e}(Laya.Sprite),__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),loginView=function(t){function e(){var e=t.call(this)||this;return e.pos((Laya.stage.width-600)/2,(Laya.stage.height-400)/2),e.bt_login.on(Laya.Event.CLICK,e,e.handleLogin),server.on("LOGIN_SUCCESS",e,e.loginSuccess),server.on("LOGIN_FAILED",e,e.loginFailed),server.on("CONNECT_ERROR",e,e.connectClose),e}return __extends(e,t),e.prototype.handleLogin=function(){var t=this.bt_input.text;if(t){var e=Number(t);1>e||e>100?Laya.stage.addChild(new promptView("输入的 uid 不在1~100之间！！")):server.connect(e)}else Laya.stage.addChild(new promptView("请输入uid"))},e.prototype.destroySelf=function(){this.removeSelf(),this.destroy()},e.prototype.loginSuccess=function(t){var e=new gameMain;e.mainProcess(t),this.destroySelf()},e.prototype.loginFailed=function(){Laya.stage.addChild(new promptView("登陆失败！"))},e.prototype.connectClose=function(){Laya.stage.addChild(new promptView("连接已经断开，请重新登陆！"))},e}(ui.loginUI),__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),promptView=function(t){function e(e){var o=t.call(this)||this;return o.pos((Laya.stage.width-600)/2,(Laya.stage.height-400)/2),o.bt_return.on(Laya.Event.CLICK,o,o.handleClose),e&&(o.bt_prompt.text=e,o.bt_prompt.fontSize=15),o}return __extends(e,t),e.prototype.handleClose=function(){this.removeSelf(),this.destroy()},e}(ui.promptUI),GameMain=function(){function t(){Laya.init(600,400,laya.webgl.WebGL),this.initStage(),this.loadResource()}return t.prototype.initStage=function(){Laya.stage.scaleMode=Laya.Stage.SCALE_SHOWALL,Laya.stage.screenMode=Laya.Stage.SCREEN_HORIZONTAL,Laya.stage.alignV=Laya.Stage.ALIGN_CENTER,Laya.stage.alignH=Laya.Stage.ALIGN_CENTER,Laya.stage.bgColor="#232628"},t.prototype.loadResource=function(){var t=[{url:"res/atlas/comp.atlas",type:Laya.Loader.ATLAS},{url:"res/proto/user.proto"},{url:"res/proto/game.proto"}];Laya.loader.load(t,Laya.Handler.create(this,function(){server=new Server,Laya.stage.addChild(new loginView)}))},t}();new GameMain;